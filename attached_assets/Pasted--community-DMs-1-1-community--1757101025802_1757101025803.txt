×”××©×š ×¤×¨×•××¤×˜ ×œÖ¾/community: DMs (×—×“×¨×™× ×¤×¨×˜×™×™× 1-×¢×œ-1) + ×§×‘×¦×™×/×ª××•× ×•×ª

×¢×“×›×Ÿ ××ª ×”×“×£ ×”×§×™×™× /community (××™×Ÿ ×œ×™×¦×•×¨ ×“×£ ×—×“×©). ×”×•×¡×£:

Direct Messages (DMs) â€” ×—×“×¨×™× ×¤×¨×˜×™×™× 1-×¢×œ-1 ×¢× ×¨×©×™××ª ×©×™×—×•×ª, ×¤×ª×™×—×ª ×©×™×—×” ×—×“×©×”, ×•×”×•×“×¢×•×ª ×‘×–××Ÿ ×××ª.

×¦×™×¨×•×£ ×ª××•× ×•×ª/×§×‘×¦×™× ×œ×”×•×“×¢×•×ª, ×›×•×œ×œ ×”×¢×œ××” ×œ-Supabase Storage, ×ª×¦×•×’×ª ×ª×¦×•×’×” ××§×“×™××” (preview), ×•×”×•×¨×“×”.

×‘×¦×¢ ××ª ×”×©×™× ×•×™×™× ×‘×¢×“×™× ×•×ª (backwards-compatible). ×× ××™×Ÿ ×¢××•×“×•×ª/×˜×‘×œ××•×ª â€” ×ª×ª××™× ××•×˜×•××˜×™×ª, ×•××œ ×ª×§×¨×™×¡ ×× ×—×¡×¨.

A) ××•×“×œ × ×ª×•× ×™× â€” ×”×¨×—×‘×” ×¨×›×” (×œ×œ× ×©×‘×™×¨×ª ×§×™×™×)

chat_rooms: ×”×•×¡×£ ×ª××™×›×” ×œ-type:

type='public' | 'private' | 'dm' (×× ××™×Ÿ ×¢××•×“×” â€” ×ª×¢×‘×•×“ ×œ×•×’×™×ª ×‘××¤×ª×— ××©× ×™: ×©××¨ metadata->>'type' ×‘-JSON ×× ×™×© ×¢××•×“×ª JSON; ××—×¨×ª ××œ ×ª×§×¨×™×¡ ×•×”×©×ª××© ×‘×§×•× ×‘× ×¦×™×” ×œ×¤×™ ×©× ×”×—×“×¨, dm:<uidA>-<uidB>).

chat_room_members (×˜×‘×œ×ª ×¢×–×¨ ×—×“×©×” ×× ×œ× ×§×™×™××ª):

×¢××•×“×•×ª ××•×¦×¢×•×ª: id uuid PK, room_id uuid, user_id uuid NULL, guest_name text NULL, created_at timestamptz default now().

×× ××™×Ÿ Auth (users ×¨×™×§) â€” ×ª××•×š ×‘-guest mode ×¢×´×™ guest_name ×•××—×¡×•×Ÿ ×˜×•×§×Ÿ ×§×¦×¨ ×‘-localStorage ×›×“×™ ×œ×–×”×•×ª â€œ×‘×¢×œ×•×ªâ€ ×¢×œ ×”×”×•×“×¢×•×ª.

messages: ××œ ×ª×©×‘×•×¨. ×”×•×¡×£ ×™×›×•×œ×ª ×œ×¦×¨×£ ×§×‘×¦×™× ×“×¨×š ×˜×‘×œ×ª ×¢×–×¨:

chat_attachments (×˜×‘×œ×ª ×¢×–×¨ ×—×“×©×” ×× ×œ× ×§×™×™××ª):

id uuid PK, message_id uuid, bucket text, path text, url text, mime_type text, size_bytes int, width int NULL, height int NULL, created_at timestamptz default now().

×× ×™×¦×™×¨×ª ×˜×‘×œ××•×ª ×—×“×©×” ×œ× ××¤×©×¨×™×ª ×¢×›×©×™×•, ×ª×¢×‘×•×“ ×‘××¦×‘ Inline: ×”×•×¡×£ ×œ×©×“×” ×§×™×™× ×‘Ö¾messages (×œ××©×œ attachments jsonb) ×× ×”×•× ×§×™×™×; ××—×¨×ª ×©××•×¨ ××ª ×›×ª×•×‘×•×ª ×”×§×‘×¦×™× ×‘×©×“×” ×˜×§×¡×˜ content ×¢× Markdown-style (×œ× ××•××œ×¥ â€” ×”×©×ª××© ×¨×§ ×›-fallback).

B) Supabase Storage â€” bucket ×œ×”×¢×œ××•×ª

×¦×•×¨/×”×©×ª××© ×‘-bucket ×‘×©× chat-uploads.

×”×¢×œ××” ×“×¨×š ×”×§×œ×™×™× ×˜, × ×ª×™×‘:
chat-uploads/{room_id}/{yyyy}/{mm}/{dd}/{random}-{filename}

×©××•×¨ ×ª×•×¦××” ×‘-chat_attachments (××• ×‘-attachments jsonb fallback).

×”×¦×’ ×§×™×©×•×¨ ×—×ª×•× (signed URL) ×× ×”-bucket ×œ× ×¦×™×‘×•×¨×™.

RLS Storage (×ª×™×¢×•×“ ×‘×œ×‘×“, ×œ× ×œ×”×¨×™×¥ ××•×˜×•××˜×™×ª):

×‘Ö¾docs/community-rls.md ×”×•×¡×£ ×§×˜×¢ SQL ×œ×“×•×’××ª ××“×™× ×™×•×ª DEV ×¤×ª×•×—×” ×œ×§×¨×™××”, ×›×ª×™×‘×” ×œ××•×¨×©×™×, ×•×œ-PROD ×œ×¤×™ room_id âˆˆ ×”×—×“×¨×™× ×©×”××©×ª××© ×—×‘×¨ ×‘×”×.

C) UI â€” DMs

×”×•×¡×£ ×˜××‘ â€œDirect Messagesâ€ ×œ×¦×“ Chat Rooms ×•-Travel Buddy.

Sidebar DMs:

×¨×©×™××ª ×©×™×—×•×ª 1-×¢×œ-1 (×©× ×”× ××¢×Ÿ, ×”×•×“×¢×” ××—×¨×•× ×”, ×–××Ÿ, ×‘××“×’â€™ ×œ× × ×§×¨××• ×× ×™×©).

×›×¤×ª×•×¨ â€œNew DMâ€:

×× ×™×© Auth: Modal ×‘×—×™×¨×ª ××©×ª××© (autocomplete ×œ×¤×™ ×˜×‘×œ×ª users ×× ×§×™×™××ª / ××• ×”×–×Ÿ ×™×“× ×™×ª ××–×”×”/×©×).

×× ××™×Ÿ Auth: ×‘×§×© partner_nickname ×•×¤×ª×— ×—×“×¨ DM ×¢×œ ×‘×¡×™×¡ guest_name.

×¤×ª×™×—×ª DM:

×‘×“×•×§ ×× ×™×© ×›×‘×¨ ×—×“×¨ ×¢× ×‘×Ÿ ×”×–×•×’ (×œ×¤×™ ×–×•×’ ×™×™×—×•×“×™ uidA, uidB ××• ×©××•×ª ×”××•×¨×—×™×); ×× ×›×Ÿ â€” ×¤×ª×— ××•×ª×•; ×× ×œ× â€” ×¦×•×¨ chat_rooms ×—×“×© ×¢× type='dm' + chat_room_members ×¢× ×©× ×™ ×”×¦×“×“×™×.

RoomView ×œ-DM:

×–×”×” ×œ-×—×“×¨ ×¨×’×™×œ: ×”×•×“×¢×•×ª ×‘×–××Ÿ ×××ª, ××™× ×¡×•×£-×¡×§×•×œ ×œ×˜×¢×™× ×ª ×¢×‘×¨, composer ×œ××˜×”.

×”×¦×’ ×›×•×ª×¨×ª ×”× ××¢×Ÿ + ×¡×˜×˜×•×¡ â€œtypingâ€¦â€ (××•×¤×¦×™×•× ×œ×™, section G).

×¤×¢×•×œ×” â€œBlock/Leaveâ€ (×¨×©×•×ª): ××¡××Ÿ ××ª ×”×—×“×¨ ×›×œ× ×¤×¢×™×œ ×œ××©×ª××© ×”× ×•×›×—×™ (××œ ×ª××—×§ ×”×•×“×¢×•×ª).

D) UI â€” ×¦×™×¨×•×£ ×ª××•× ×•×ª/×§×‘×¦×™×

×‘-RoomView (×’× ×‘-Chat Rooms ×•×’× ×‘-DMs):

Composer:

×›×¤×ª×•×¨ ğŸ“ (Attachments). ×××¤×©×¨ ×œ×‘×—×•×¨ ×§×•×‘×¥/×™× (×ª××•× ×”, PDF, DOCX, ×•×›×•â€™).

×”×’×‘×œ×•×ª: ×¢×“ X ×§×‘×¦×™× ×‘×•-×–×× ×™×ª (×œ××©×œ 5), ×’×•×“×œ ××§×¡â€™ (×œ××©×œ 10MB/×§×•×‘×¥). ×¡× ×Ÿ ×¡×™×•××•×ª ×—×©×•×“×•×ª.

×ª×¦×•×’×ª preview ×œ×¤× ×™ ×©×œ×™×—×”: ×ª××•× ×•×ª ×¢× thumbnail; ×§×‘×¦×™× ××—×¨×™× ×¢× ××™×™×§×•×Ÿ ×•××˜× (×©×/×’×•×“×œ).

×”×¢×œ××” ×œ-Storage ×œ×¤× ×™/×œ××—×¨ ×™×¦×™×¨×ª ×”×”×•×“×¢×”:

××•××œ×¥: createMessage â†’ ×§×‘×œ message_id â†’ ×”×¢×œ×” ×§×‘×¦×™× ×œ-chat-uploads/... â†’ insert ×œ-chat_attachments ×¢× message_id â†’ ×¢×“×›×Ÿ ×”-UI.

Optimistic UI: ×”×¦×’ placeholder ×œ-attachment ×‘×–××Ÿ ×”×¢×œ××”; ×¢×“×›×Ÿ ×œ-URL ×›×©×”×©××™×œ×ª×” ×—×•×–×¨×ª.

×˜×™×¤×•×œ ×©×’×™××•×ª: ×× ×”×¢×œ××” × ×›×©×œ×” â€” ×”×¦×’ ×¡×˜×˜×•×¡ ×•× ×™×¡×™×•×Ÿ ×—×•×–×¨.

MessageItem:

×× ×™×© ×ª××•× ×•×ª â€” ×¨× ×“×¨ grid ×§×˜×Ÿ ×©×œ thumbnails (×¢× lightbox ×œ×¤×ª×™×—×”).

×× ×§×•×‘×¥ ×œ×-×ª××•× ×” â€” ×›×¤×ª×•×¨ ×”×•×¨×“×”/×¤×ª×™×—×”. ×”×¦×’ mime/×’×•×“×œ.

××œ ×ª×’×¨×•× ×œ×©×‘×™×¨×” ×× ××™×Ÿ chat_attachments â€” ×¤×©×•×˜ ×“×œ×’.

E) Realtime + ×”×¨×©××•×ª

Realtime messages: ×›×‘×¨ ×§×™×™× â€” ×”×•×¡×£ ×¡×™× ×•×Ÿ ×œ×¤×™ room_id.

Realtime attachments: × ×“×¨×© ×¨×§ ×× attachments × ×•×¦×¨×™× ×œ××—×¨ ×”×”×•×“×¢×” â€” ×”××–×Ÿ ×¢×œ chat_attachments ×œ×¤×™ message_id IN (...) ×©×œ ×”×”×•×“×¢×•×ª ×”×˜×¢×•× ×•×ª, ×•×¢×“×›×Ÿ UI ×›×©××’×™×¢ attachment ×—×“×©.

RLS ×œ×˜×‘×œ××•×ª ×—×“×©×•×ª (×ª×™×¢×•×“ ×‘×œ×‘×“, ×‘×§×•×‘×¥ docs/community-rls.md):

chat_room_members: select/insert ×¢×‘×•×¨ ××©×ª×ª×¤×™ ×”×—×“×¨ (DEV: ×¤×ª×•×—).

chat_attachments: select ×œ×›×œ ××™ ×©×—×‘×¨ ×‘×—×“×¨ ×©×œ message_id; insert ×œ×›×•×ª×‘ ×”×”×•×“×¢×” ×‘×œ×‘×“.

F) ×”×ª×××•×ª ×œ×œ× Auth (Guest Mode)

×©××•×¨ guest_name ×‘-localStorage (×©×“×” ×—×•×‘×” ×‘-composer ×× ×—×¡×¨).

×™×¦×™×¨×ª DM: ×× ××™×Ÿ Auth â€” ×¦×•×¨ chat_rooms ×¢× type='dm' ×•-chat_room_members ×¢× guest_name ×©×œ ×©× ×™ ×”×¦×“×“×™×.

×¤×ª×™×—×ª DM ×“×¨×š ×§×™×©×•×¨: ×ª××•×š ×‘-URL ×›××• /community?dm=guest:Alice ×œ×”×ª×—×œ×ª ×—×“×¨ ×¢× Alice (×× ××™× × ×• â€” ×¦×•×¨).

×”×¦×’ ×‘-MessageItem: author_name || user_id || 'Guest'.

G) ×ª×•×¡×¤×•×ª ×§×˜× ×•×ª ×•××©××¢×•×ª×™×•×ª

Typing indicator (××•×¤×¦×™×•× ×œ×™ ××š × ×—××“):

×¢×œ keydown ×‘-composer ×©×“×¨ â€œtypingâ€ ×œ-realtime channel ×©×œ ×”×—×“×¨ (debounced).

×—×™×™ ××“×“ 3â€“5 ×©× ×™×•×ª. ×”×¦×’ â€œX is typingâ€¦â€ ×œ×™×“ ×”×›×•×ª×¨×ª/××¢×œ ×”×”×•×“×¢×•×ª.

Unread badges: ×©××•×¨ last_read_ts ×¤×¨-×—×“×¨ (×‘-chat_room_members ××• ×‘-localStorage ×× ××™×Ÿ Auth); ×”×¦×’ ×ª×’×™×ª ×œ× × ×§×¨××• ×‘×¡×™×™×“×‘×¨.

×—×™×¤×•×© ×‘×”×•×“×¢×•×ª (××•×¤×¦×™×•× ×œ×™): ×ª×™×‘×ª ×—×™×¤×•×© ×©××‘×¦×¢×ª ilike ×¢×œ content ×‘×—×“×¨ × ×•×›×—×™.

H) ENV ×•-Storage

×”×©×ª××© ×‘××•×“×•×œ ENV ×”××¨×•×›×– ×©×›×‘×¨ ×™×¦×¨× ×• (src/config/env.ts) ×’× ×œ-Storage:

NEXT_PUBLIC_SUPABASE_URL/VITE_SUPABASE_URL

NEXT_PUBLIC_SUPABASE_ANON_KEY/VITE_SUPABASE_ANON_KEY

××œ ×ª×§×©×™×— ××¤×ª×—×•×ª.

×‘×“×•×§ CORS ×œ-Storage ×× ×¦×¨×™×š.

I) ×§×‘×¦×™×/×§×•××¤×•× × ×˜×™× (×”×¨×—×‘×” ×¢×“×™× ×” ×œ×§×™×™××™×)

src/components/community/SidebarDMs.tsx â€” ×¨×©×™××ª DMs + New DM

×¢×“×›×•× ×™× ×‘-RoomView.tsx, MessageItem.tsx, ChatSidebar.tsx:

×ª××™×›×” ×‘-attachments, previews, lightbox

×—×™×•×•×™ typing (×× ×××•××©)

src/lib/communityApi.ts:

createDmRoom(partner)

listDmRooms()

uploadAttachment(roomId, file) â†’ ×”×—×–×¨×ª ×”××˜× + ×™×¦×™×¨×ª chat_attachments

listAttachmentsByMessageIds(ids: string[])

docs/community-rls.md â€” ×”×•×¡×£ ×§×˜×¢×™ SQL ×œ-RLS ×œ×˜×‘×œ××•×ª ×”×—×“×©×•×ª + Storage (DEV/PROD).

J) Acceptance (×§×‘×œ×”)

×˜××‘ Direct Messages ××•×¦×’; × ×™×ª×Ÿ ×œ×¤×ª×•×—/×œ××¦×•× ×©×™×—×•×ª 1-×¢×œ-1.

×™×¦×™×¨×ª DM ×¤×•×¢×œ×ª (×¢× Auth ××• guest_name). ×—×“×¨ ×§×™×™× ×××•×—×–×¨; ×—×“×© × ×•×¦×¨ ×× ××™×Ÿ.

×©×œ×™×—×ª ×”×•×“×¢×” ×‘-DM ×¢×•×‘×“×ª ×‘×–××Ÿ ×××ª; ××™× ×¡×•×£-×¡×§×•×œ ×œ×˜×¢×™× ×ª ×¢×‘×¨.

×”×¢×œ××ª ×ª××•× ×•×ª/×§×‘×¦×™× ××”-composer ×¢×•×‘×“×ª; attachments ××•×¦×’×™× ×‘×”×•×“×¢×” (×ª××•× ×•×ª ×›-thumbnails; ×§×‘×¦×™× ×›-downloadable).

××™×Ÿ ×”×§×©×—×ª ××¤×ª×—×•×ª; ×”×›×œ ENV.

××™×Ÿ ×©×‘×™×¨×ª /community ×‘-Chat Rooms / Travel Buddy.

×‘××¡××›×™ docs/ ×™×© ×”×•×¨××•×ª RLS/Storage ×‘×¨×•×¨×•×ª (×œ× ×¨×¦×•×ª ××•×˜×•××˜×™×ª).

Commit ×‘×¡×•×£:
feat(community): private 1-1 DMs + chat attachments (images/files) with storage & realtime