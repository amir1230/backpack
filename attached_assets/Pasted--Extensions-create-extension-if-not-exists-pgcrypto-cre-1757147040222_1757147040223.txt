-- Extensions (בדרך כלל מותקן כבר, אך להרצה בטוחה):
create extension if not exists "pgcrypto";
create extension if not exists "uuid-ossp";

-- =========================
-- 1) itineraries (master)
-- =========================
create table if not exists public.itineraries (
  id          uuid primary key default gen_random_uuid(),
  user_id     uuid not null,                -- auth.users.id
  title       text,
  plan_json   jsonb not null,               -- האיטינררי המלא כפי שנוצר באפליקציה
  created_at  timestamptz not null default now(),
  updated_at  timestamptz not null default now()
);

-- טריגר updated_at אוטומטי
create or replace function public.touch_updated_at()
returns trigger language plpgsql as $$
begin
  new.updated_at := now();
  return new;
end; $$;

drop trigger if exists itineraries_touch_updated_at on public.itineraries;
create trigger itineraries_touch_updated_at
before update on public.itineraries
for each row execute function public.touch_updated_at();

-- אינדקסים
create index if not exists idx_itineraries_user_id on public.itineraries (user_id);
create index if not exists idx_itineraries_created_at on public.itineraries (created_at);
create index if not exists idx_itineraries_plan_json_gin on public.itineraries using gin (plan_json);

-- =========================
-- 2) itinerary_items (optional detail table)
-- =========================
create table if not exists public.itinerary_items (
  id            uuid primary key default gen_random_uuid(),
  itinerary_id  uuid not null references public.itineraries(id) on delete cascade,
  day_index     int not null default 0,
  entity_type   text not null check (entity_type in ('destination','attraction','restaurant','accommodation')),
  entity_id     uuid,        -- אם יש לכם entities בטבלאות אחרות
  external_id   text,        -- לחלופין מזהה חיצוני (Google/Wiki/OTM)
  meta          jsonb,       -- פרטים גמישים (שם, כתובת, lat/lon, שעות פתיחה, וכו')
  created_at    timestamptz not null default now()
);

create index if not exists idx_items_itinerary_id on public.itinerary_items (itinerary_id);
create index if not exists idx_items_day on public.itinerary_items (day_index);
create index if not exists idx_items_meta_gin on public.itinerary_items using gin (meta);

-- =========================
-- 3) RLS Policies
-- =========================
-- הפעלת RLS
alter table public.itineraries enable row level security;
alter table public.itinerary_items enable row level security;

-- OWNER: המשתמש יכול לצפות/ליצור/לעדכן/למחוק רק את שלו
-- itineraries
drop policy if exists "itineraries_select_own" on public.itineraries;
create policy "itineraries_select_own"
on public.itineraries
for select
using (auth.uid() = user_id);

drop policy if exists "itineraries_insert_own" on public.itineraries;
create policy "itineraries_insert_own"
on public.itineraries
for insert
with check (auth.uid() = user_id);

drop policy if exists "itineraries_update_own" on public.itineraries;
create policy "itineraries_update_own"
on public.itineraries
for update
using (auth.uid() = user_id)
with check (auth.uid() = user_id);

drop policy if exists "itineraries_delete_own" on public.itineraries;
create policy "itineraries_delete_own"
on public.itineraries
for delete
using (auth.uid() = user_id);

-- itinerary_items (קשורים ל-itineraries של המשתמש)
drop policy if exists "items_select_own" on public.itinerary_items;
create policy "items_select_own"
on public.itinerary_items
for select
using (
  exists (
    select 1 from public.itineraries i
    where i.id = itinerary_items.itinerary_id
      and i.user_id = auth.uid()
  )
);

drop policy if exists "items_insert_own" on public.itinerary_items;
create policy "items_insert_own"
on public.itinerary_items
for insert
with check (
  exists (
    select 1 from public.itineraries i
    where i.id = itinerary_items.itinerary_id
      and i.user_id = auth.uid()
  )
);

drop policy if exists "items_update_own" on public.itinerary_items;
create policy "items_update_own"
on public.itinerary_items
for update
using (
  exists (
    select 1 from public.itineraries i
    where i.id = itinerary_items.itinerary_id
      and i.user_id = auth.uid()
  )
)
with check (
  exists (
    select 1 from public.itineraries i
    where i.id = itinerary_items.itinerary_id
      and i.user_id = auth.uid()
  )
);

drop policy if exists "items_delete_own" on public.itinerary_items;
create policy "items_delete_own"
on public.itinerary_items
for delete
using (
  exists (
    select 1 from public.itineraries i
    where i.id = itinerary_items.itinerary_id
      and i.user_id = auth.uid()
  )
);
