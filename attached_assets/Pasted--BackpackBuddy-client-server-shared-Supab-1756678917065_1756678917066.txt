אתה עובד על פרויקט BackpackBuddy שלי (client/server/shared).
המטרה: לנקות ולהגדיר חיבור תקין ל-Supabase, להחזיר את השרת ליציבות, לוודא שהטבלאות נגישות, ולתקן את הדשבורד שמציג “Table not found or inaccessible”.
חשוב: אל תציג לי קוד. כתוב את הקוד בעצמך בקבצים המתאימים. אני רוצה לראות רק לוגיקה, פעולות, ותוצאות.

כללים כלליים

תעבוד רק עם Secrets של Replit; אל תכניס מפתחות לקבצים.

תשתמש בלקוח יחיד ל-Supabase בצד שרת (singleton).

תבדוק הרשאות/RLS רק אם נדרש גישה ישירה מהלקוח; ברירת מחדל — גישה דרך השרת.

בכל שלב תציג לי: מה עשית, איזה קבצים שינית/הוספת, ומה התוצאה בפועל (כולל סטטוס בדיקות).

שלב 1 — יישור קו משתני סביבה (Secrets)

ודא שה-Secrets ברפליט כוללים:

SUPABASE_URL בפורמט של הפרויקט שלי (הדומיין של Supabase).

SUPABASE_SERVICE_ROLE_KEY (Service key מה־Dashboard).

SUPABASE_ANON_KEY (Public anon key מה־Dashboard).

DATABASE_URL שמצביע למסד הנתונים של Supabase, ולא ל-Neon.

מחק כל Secret שקשור ל-Neon או חיבורים ישנים.

אשר לי בכתב את הערכים הלוגיים (דוגמאות ללא חשיפת מפתחות), והסבר איך גזרת את DATABASE_URL הנכון (כולל שימוש ב-pooler אם בחרת בו).

תוצאה נדרשת: יש רק Secrets של Supabase, והם בפורמט תקין.

שלב 2 — אימות קונפיגורציה והפרדת אחריות

ודא שיש מודול קונפיגורציה מרוכז שמוודא את כל משתני הסביבה (כולל ולידציה).

ודא שיש מודול חיבור יחיד ל-Supabase (בשרת) שנוצר פעם אחת בלבד.

אשר שהשרת אינו יוצר לקוחות/חיבורים בכל בקשה.

ודא שהלקוח (frontend) לא משתמש במפתח Service Role בשום מצב.

תוצאה נדרשת: קיים אימות ENV, לקוח Supabase יחיד בשרת, ואין חשיפת מפתחות רגישים לצד לקוח.

שלב 3 — בריאות שרת ויציבות

הוסף/ודא קיום נקודת בדיקה לבריאות השירות (health/ready).

קנפג זמני timeouts, keep-alive, ו-headers כדי למנוע ניתוקים אקראיים בפרוקסי של Replit.

הוסף לוגיקה גלובלית לתפיסת חריגות ושגיאות א-סינכרוניות.

אשר שהשרת מאזין לפורט הנכון (מה-ENV) ולא לפורט קשיח.

תוצאה נדרשת: השרת רץ יציב וניתן לבדוק אותו בדפדפן/preview דרך health.

שלב 4 — בדיקת חיבור ל-Supabase מסביבת השרת

צור סקריפט בדיקה קטן בצד שרת שמוודא:

שניתן לפנות ל-Supabase (חיבור, אימות).

שקיימת גישה לטבלה אחת לפחות (למשל destinations) או החזר שגיאה מפורשת אם אינה קיימת.

הרץ את הסקריפט ממסוף Replit ואסוף תוצאות.

תוצאה נדרשת: קיבלנו חיווי ברור — הטבלה קיימת ונגישה, או אין טבלה/אין הרשאה.

שלב 5 — התאמת הנתיב שמזין את הדשבורד

בדוק כיצד הדשבורד שלך משיג רשימת טבלאות (הנתיב שמחזיר “Table not found or inaccessible”).

אם הדשבורד מסתמך על מידע סכמות דרך REST: החלף/התאם זאת לנתיב בצד שרת שמחזיר רשימת טבלאות מתוך בסיס הנתונים באופן תואם (ללא חשיפת מידע רגיש).

ודא שהנתיב מחזיר שמות טבלאות בסכמה public בלבד, בפורמט שהדשבורד שלך מצפה לו.

אשר שהתצוגה בדשבורד מתעדכנת ומציגה את הרשימה בפועל.

תוצאה נדרשת: הדשבורד מציג את שמות הטבלאות האמיתיות במקום השגיאה הכללית.

שלב 6 — אימות קיום הטבלאות והזרעת דוגמה מינימלית (אם צריך)

היכנס ל-Supabase Dashboard → SQL Editor.

אמת שהטבלאות המרכזיות קיימות (destinations, attractions, restaurants, accommodations, ועוד לפי הצורך).

אם טבלה חסרה — צור אותה לפי הסכמה המצופה בפרויקט (כולל מפתחות, סוגי עמודות, אינדקסים חיוניים).

הזרק נתוני דוגמה מינימליים (שורה-שתיים) כדי לאמת זרימה קצה-לקצה.

אמת דרך השרת שהנתונים נקראים ושהדשבורד מציג ספירות תקינות.

תוצאה נדרשת: הטבלאות קיימות עם מעט דאטה בדיקה, והמערכת מציגה אותן כראוי.

שלב 7 — הרשאות ו-RLS (רק אם הלקוח פונה ישירות ל-Supabase)

בדוק אם יש קריאות ישירות מה-client ל-Supabase. אם כן:

ודא שימוש ב-ANON KEY בלבד.

בדוק/עדכן מדיניות RLS עבור קריאה בלבד לטבלאות הנדרשות, בצורה מצומצמת וזהירה.

אם כל הקריאות עוברות דרך השרת — אין צורך בח暴ת מדיניות פתוחה בצד ה-DB.

תוצאה נדרשת: אין גישה ישירה הדורשת מדיניות רחבה מדי; ואם יש — המדיניות מאובטחת והוגדרת נכון.

שלב 8 — קשיחות ה-API והפחתת עומס

ודא שכל הנתיבים הכבדים מצמצמים עמודות/כמויות (סינון/דפדוף), כדי למנוע עומסי זיכרון.

הוסף caching קצר (בשרת) לנתיבי קריאה נפוצים בדשבורד.

הוסף Rate-Limit בסיסי ובקרת CORS מתאימה (לסביבת Replit).

תוצאה נדרשת: ה-API מגיב מהר יותר ויציב יותר תחת עומס קל, ללא חריגות.

שלב 9 — ריסטארט נקי ואימות קצה-לקצה

בצע אתחול נקי של השרת ברפליט (ודא שאין תהליכים קודמים).

אמת:

נקודת בריאות זמינה ועובדת.

נתיב בדיקה לטבלאות מחזיר רשימה תקינה.

נתיבים עסקיים עיקריים (למשל רשימת יעדים) מחזירים תוצאות בפועל.

הדשבורד שלך מציג ספירות אמיתיות ולא “Table not found or inaccessible”.

תוצאה נדרשת: כל הזרימה הראשית חזרה לפעילות תקינה.

שלב 10 — דו״ח קצר מסכם

לבסוף, תן לי סיכום תמציתי:

אילו Secrets תוקנו/נוספו.

אילו קבצים נערכו/נוספו ולמה.

מה מצב החיבור ל-Supabase עכשיו.

האם הטבלאות קיימות ומה מצב הדשבורד.

אילו נקודות עדיין דורשות תשומת לב (אם יש).