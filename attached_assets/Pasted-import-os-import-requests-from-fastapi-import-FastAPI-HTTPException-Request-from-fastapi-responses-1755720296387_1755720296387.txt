import os
import requests
from fastapi import FastAPI, HTTPException, Request
from fastapi.responses import JSONResponse, HTMLResponse
from fastapi.middleware.cors import CORSMiddleware
from fastapi.staticfiles import StaticFiles
from fastapi.templating import Jinja2Templates

# ==== Secrets (מוגדרים ב-Replit > Secrets) ====
GOOGLE_PLACES_KEY = os.getenv("GOOGLE_PLACES_KEY")   # שרת: Places API
BROWSER_KEY = os.getenv("BROWSER_KEY")               # דפדפן: Maps JavaScript API

if not GOOGLE_PLACES_KEY:
    raise RuntimeError("חסר GOOGLE_PLACES_KEY ב-Secrets")
if not BROWSER_KEY:
    raise RuntimeError("חסר BROWSER_KEY ב-Secrets")

# ==== FastAPI ====
app = FastAPI(title="TripWise Collector")

# אם תריץ פרונט נפרד, תשאיר CORS פתוח; אם הכל באותו שרת זה לא קריטי
app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],  # אפשר לצמצם לדומיין של ה-Repl שלך
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

# Static & Templates
app.mount("/static", StaticFiles(directory="static"), name="static")
templates = Jinja2Templates(directory="templates")

# ==== Home: מגיש את index.html ומזריק את מפתח ה-BROWSER_KEY ====
@app.get("/", response_class=HTMLResponse)
def home(request: Request):
    return templates.TemplateResponse("index.html", {"request": request, "browser_key": BROWSER_KEY})

# ==== Health ====
@app.get("/health")
def health():
    return {"ok": True}

# ==== Google Places (Server → Reviews/Details) ====
FIELDS = ",".join([
    "id",
    "displayName",
    "formattedAddress",
    "internationalPhoneNumber",
    "rating",
    "userRatingCount",
    "websiteUri",
    "location",
    "currentOpeningHours",
    "editorialSummary",
    "reviews"
])

@app.get("/api/place-details")
def place_details(place_id: str):
    url = f"https://places.googleapis.com/v1/places/{place_id}"
    headers = {
        "X-Goog-Api-Key": GOOGLE_PLACES_KEY,
        "X-Goog-FieldMask": FIELDS
    }
    r = requests.get(url, headers=headers, timeout=15)
    if r.status_code != 200:
        raise HTTPException(status_code=r.status_code, detail=r.text)

    p = r.json()
    return JSONResponse({
        "name": (p.get("displayName") or {}).get("text"),
        "address": p.get("formattedAddress"),
        "phone": p.get("internationalPhoneNumber"),
        "rating": p.get("rating"),
        "reviews_count": p.get("userRatingCount"),
        "website": p.get("websiteUri"),
        "lat": (p.get("location") or {}).get("latitude"),
        "lng": (p.get("location") or {}).get("longitude"),
        "opening_hours": (p.get("currentOpeningHours") or {}).get("weekdayDescriptions"),
        "summary": (p.get("editorialSummary") or {}).get("text"),
        "reviews": [
            {
                "rating": rv.get("rating"),
                "text": (rv.get("text") or {}).get("text"),
                "publishTime": rv.get("publishTime"),
                "authorAttribution": (rv.get("authorAttribution") or {}).get("displayName")
            } for rv in p.get("reviews", [])
        ]
    })

# הרצה מקומית אם צריך (ב-Replit אפשר לשים ב-Run: uvicorn server:app --host 0.0.0.0 --port 8000)
if __name__ == "__main__":
    import uvicorn
    uvicorn.run("server:app", host="0.0.0.0", port=8000, reload=True)